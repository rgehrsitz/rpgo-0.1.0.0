# Monte Carlo Simulation Implementation

## Overview

The Monte Carlo simulation engine provides probabilistic analysis of retirement portfolio sustainability using historical market data or statistical distributions. This implementation allows users to test different withdrawal strategies, asset allocations, and market conditions to assess retirement planning risks.

## Architecture

### Core Components

1. **MonteCarloSimulator**: Main simulation engine
2. **HistoricalDataManager**: Provides historical market data
3. **MonteCarloConfig**: Configuration for simulation parameters
4. **MonteCarloResult**: Comprehensive simulation results

### Key Features

- **Historical Data Sampling**: Uses real TSP fund returns, inflation, and COLA data
- **Statistical Distributions**: Fallback to normal distributions based on historical statistics
- **Multiple Withdrawal Strategies**: Fixed amount, percentage, inflation-adjusted, guardrails
- **Parallel Processing**: Efficient simulation execution
- **Risk Assessment**: Success rates, percentile analysis, drawdown tracking

## Usage

### CLI Commands

```bash
# Basic Monte Carlo simulation
./fers-calc historical monte-carlo ./data

# Customized simulation
./fers-calc historical monte-carlo ./data \
  --simulations 1000 \
  --years 30 \
  --balance 1000000 \
  --withdrawal 40000 \
  --strategy guardrails

# Statistical mode (not historical)
./fers-calc historical monte-carlo ./data \
  --simulations 500 \
  --historical false
```

### Programmatic Usage

```go
// Create historical data manager
hdm := calculation.NewHistoricalDataManager("./data")
hdm.LoadAllData()

// Configure simulation
config := calculation.MonteCarloConfig{
    NumSimulations:   1000,
    ProjectionYears:  25,
    UseHistorical:    true,
    AssetAllocation: map[string]decimal.Decimal{
        "C": decimal.NewFromFloat(0.6), // 60% C Fund
        "S": decimal.NewFromFloat(0.2), // 20% S Fund
        "I": decimal.NewFromFloat(0.1), // 10% I Fund
        "F": decimal.NewFromFloat(0.1), // 10% F Fund
    },
    WithdrawalStrategy: "guardrails",
    InitialBalance:     decimal.NewFromInt(1000000),
    AnnualWithdrawal:   decimal.NewFromInt(40000),
}

// Run simulation
simulator := calculation.NewMonteCarloSimulator(hdm, config)
result, err := simulator.RunSimulation(config)
```

## Withdrawal Strategies

### 1. Fixed Amount
- **Description**: Withdraw the same dollar amount each year
- **Use Case**: Simple budgeting, predictable income
- **Risk**: No inflation protection, may deplete portfolio in high-inflation periods

### 2. Fixed Percentage
- **Description**: Withdraw a fixed percentage of current portfolio balance
- **Use Case**: Income varies with portfolio performance
- **Risk**: Income volatility, may be insufficient in down markets

### 3. Inflation-Adjusted
- **Description**: Initial withdrawal adjusted annually for inflation
- **Use Case**: Maintains purchasing power over time
- **Risk**: May deplete portfolio if returns don't keep pace with inflation

### 4. Guardrails
- **Description**: Dynamic adjustment based on portfolio performance
- **Logic**: 
  - Reduce withdrawal by 10% if withdrawal rate exceeds 6%
  - Floor: Don't reduce below 80% of original withdrawal
- **Use Case**: Balance income needs with portfolio sustainability
- **Risk**: Income variability, but better portfolio protection

## TSP Configuration

### Important Limitation
For Monte Carlo simulations to show proper TSP balance variability, **manual TSP allocations must be used instead of lifecycle funds**:

‚úÖ **Recommended (shows variation)**:
```yaml
tsp_allocation:
  c_fund: "0.60"  # 60% C Fund
  s_fund: "0.20"  # 20% S Fund  
  i_fund: "0.10"  # 10% I Fund
  f_fund: "0.10"  # 10% F Fund
  g_fund: "0.00"  # 0% G Fund
```

‚ùå **Avoid for Monte Carlo (produces identical results)**:
```yaml
tsp_lifecycle_fund:
  fund_name: "L2030"
```

**Reason**: Lifecycle funds use deterministic allocation calculations that don't reflect the varying market conditions generated by Monte Carlo simulations.

## Asset Allocation

The simulation supports all TSP funds with customizable allocations:

| Fund | Description | Historical Mean | Historical Std Dev |
|------|-------------|-----------------|-------------------|
| C Fund | S&P 500 Index | 11.25% | 17.44% |
| S Fund | Small Cap | 11.17% | 19.33% |
| I Fund | International | 6.34% | 18.63% |
| F Fund | Bonds | 5.32% | 5.65% |
| G Fund | Government Securities | 4.93% | 1.65% |

### Example Allocations

**Conservative (30/70)**
```go
{
    "F": decimal.NewFromFloat(0.7), // 70% bonds
    "C": decimal.NewFromFloat(0.3), // 30% stocks
}
```

**Moderate (60/40)**
```go
{
    "C": decimal.NewFromFloat(0.4), // 40% large cap
    "S": decimal.NewFromFloat(0.2), // 20% small cap
    "F": decimal.NewFromFloat(0.4), // 40% bonds
}
```

**Aggressive (80/20)**
```go
{
    "C": decimal.NewFromFloat(0.5), // 50% large cap
    "S": decimal.NewFromFloat(0.2), // 20% small cap
    "I": decimal.NewFromFloat(0.1), // 10% international
    "F": decimal.NewFromFloat(0.2), // 20% bonds
}
```

## Market Data Sources

### Historical Mode
- **TSP Returns**: Actual annual returns from TSP.gov (1990-2023)
- **Inflation**: CPI-U rates from BLS.gov
- **COLA**: Social Security COLA rates from SSA.gov
- **Sampling**: Random selection from historical years

### Statistical Mode
- **Distributions**: Normal distributions based on historical statistics
- **Correlation**: Simplified correlation modeling
- **Advantage**: More scenarios, but less realistic market sequences

## Results Analysis

### Success Metrics

**Success Rate**: Percentage of simulations where portfolio lasts the full projection period
- üü¢ **Low Risk**: 95%+ success rate
- üü° **Moderate Risk**: 85-95% success rate  
- üü† **High Risk**: 75-85% success rate
- üî¥ **Very High Risk**: <75% success rate

### Percentile Analysis

**Ending Balance Percentiles**: Distribution of final portfolio values
- **P10**: 10% of simulations end with this balance or less
- **P25**: 25% of simulations end with this balance or less
- **P50**: Median ending balance
- **P75**: 75% of simulations end with this balance or less
- **P90**: 90% of simulations end with this balance or less

### Risk Metrics

**Maximum Drawdown**: Largest peak-to-trough decline in portfolio value
**Total Withdrawn**: Cumulative withdrawals over the projection period

## Performance Considerations

### Parallel Processing
- Simulations run concurrently with semaphore limiting
- Optimal for 1000+ simulations
- Memory usage scales with simulation count

### Optimization Tips
- Use 100-500 simulations for quick testing
- Use 1000-5000 simulations for final analysis
- Historical mode is more realistic but slower
- Statistical mode is faster but less realistic

## Example Results

### Scenario 1: Conservative 4% Rule
```
Initial Balance: $1,000,000
Annual Withdrawal: $40,000 (4%)
Asset Allocation: 60% C, 20% S, 10% I, 10% F
Projection Years: 25

Results:
- Success Rate: 99%
- Median Ending Balance: $6,630,937
- Risk Assessment: üü¢ LOW RISK
```

### Scenario 2: Aggressive 6% Rule
```
Initial Balance: $500,000
Annual Withdrawal: $30,000 (6%)
Asset Allocation: 80% C, 20% S
Projection Years: 25

Results:
- Success Rate: 82%
- Median Ending Balance: $0
- Risk Assessment: üü† HIGH RISK
```

## Recommendations

### For Low Success Rates (<85%)
- Reduce withdrawal amount
- Increase bond allocation (F/G funds)
- Consider working longer
- Increase savings rate

### For High Success Rates (>95%)
- Current plan appears sustainable
- Consider increasing withdrawal
- Take more investment risk
- Plan for legacy goals

### General Guidelines
- Start with 4% withdrawal rate
- Use guardrails strategy for flexibility
- Maintain 20-40% bond allocation
- Monitor and adjust annually

## Future Enhancements

### Planned Features
- **Correlation Modeling**: More sophisticated asset correlation
- **Tax Modeling**: Include tax implications in simulations
- **Sequence Risk Analysis**: Focus on early retirement years
- **Custom Distributions**: Non-normal return distributions
- **Scenario Comparison**: Side-by-side strategy analysis

### Advanced Withdrawal Strategies
- **Floor-Ceiling**: Minimum/maximum withdrawal bounds
- **Bond Tent**: Dynamic asset allocation based on age
- **Variable Percentage**: Dynamic withdrawal rates
- **RMD Integration**: Required Minimum Distribution compliance

## Testing

### Test Coverage
- ‚úÖ Basic simulation functionality
- ‚úÖ Historical vs statistical modes
- ‚úÖ All withdrawal strategies
- ‚úÖ Various asset allocations
- ‚úÖ Percentile calculations
- ‚úÖ Error handling

### Validation
- Success rates align with academic research
- Historical replay matches known outcomes
- Statistical distributions match historical data
- Edge cases handled appropriately

## Integration

The Monte Carlo engine integrates with the existing FERS retirement calculator:

- **Historical Data**: Shared with deterministic calculations
- **Domain Models**: Compatible with existing structures
- **CLI Interface**: Consistent with other commands
- **Output Formats**: Can be extended to HTML/JSON reports

This implementation provides a robust foundation for probabilistic retirement planning analysis while maintaining compatibility with the existing deterministic calculation engine. 